name: Branch Name Check
on:
  create:
  push:
  pull_request:

jobs:
  check-branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name and source
        run: |
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            BRANCH_NAME="$GITHUB_HEAD_REF"
          else
            BRANCH_NAME="$GITHUB_REF_NAME"
          fi

          if [[ "$BRANCH_NAME" == "develop" || "$BRANCH_NAME" == "main" ]]; then
            echo "‚ÑπÔ∏è –í–µ—Ç–∫–∞ $BRANCH_NAME –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏"
            exit 0
          fi

          FEATURE_PATTERN="^feature/QW-[0-9]+-[a-z0-9-]+$"
          RELEASE_PATTERN="^release/[0-9]+\.[0-9]+\.[0-9]+$"
          FIX_PATTERN="^fix/QW-[0-9]+-[a-z0-9-]+$"

          ERROR_MSG="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ç–∫–∏ –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫! –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
          1. Feature: feature/QW-<id>-<–æ–ø–∏—Å–∞–Ω–∏–µ> (–Ω–∞–ø—Ä–∏–º–µ—Ä, feature/QW-123-user-profile)
             - –û—Ç–≤–µ—Ç–≤–ª—è–µ—Ç—Å—è –æ—Ç develop –∏–ª–∏ main
          2. Release: release/<–≤–µ—Ä—Å–∏—è> (–Ω–∞–ø—Ä–∏–º–µ—Ä, release/1.3.0)
             - –û—Ç–≤–µ—Ç–≤–ª—è–µ—Ç—Å—è –æ—Ç develop –∏–ª–∏ main
          3. Fix: fix/QW-<id>-<–æ–ø–∏—Å–∞–Ω–∏–µ> (–Ω–∞–ø—Ä–∏–º–µ—Ä, fix/QW-456-login-security)
             - –û—Ç–≤–µ—Ç–≤–ª—è–µ—Ç—Å—è –æ—Ç develop –∏–ª–∏ main
          –ò–º—è –≤–µ—Ç–∫–∏: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" =~ $FEATURE_PATTERN ]]; then
            echo "üîç –í–µ—Ç–∫–∞ $BRANCH_NAME ‚Äî feature"
            EXPECTED_SOURCE="develop|main"
          elif [[ "$BRANCH_NAME" =~ $RELEASE_PATTERN ]]; then
            echo "üîç –í–µ—Ç–∫–∞ $BRANCH_NAME ‚Äî release"
            EXPECTED_SOURCE="develop|main"
          elif [[ "$BRANCH_NAME" =~ $FIX_PATTERN ]]; then
            echo "üîç –í–µ—Ç–∫–∞ $BRANCH_NAME ‚Äî fix"
            EXPECTED_SOURCE="develop|main"
          else
            echo "$ERROR_MSG"
            echo "‚ùå –í–µ—Ç–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É"
            exit 1
          fi

          # –ü–æ–ª—É—á–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–π –∫–æ–º–º–∏—Ç, –æ–±—â–∏–π —Å develop –∏–ª–∏ main
          SOURCE_BRANCH=$(git merge-base --fork-point origin/develop "$BRANCH_NAME" 2>/dev/null || git merge-base --fork-point origin/main "$BRANCH_NAME" 2>/dev/null)
          if [ -z "$SOURCE_BRANCH" ]; then
            echo "$ERROR_MSG"
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–µ—Ç–∫–∏ $BRANCH_NAME"
            exit 1
          fi

          if git merge-base --is-ancestor "$SOURCE_BRANCH" origin/develop 2>/dev/null; then
            echo "‚úÖ –í–µ—Ç–∫–∞ $BRANCH_NAME –æ—Ç–≤–µ—Ç–≤–ª–µ–Ω–∞ –æ—Ç develop"
          elif git merge-base --is-ancestor "$SOURCE_BRANCH" origin/main 2>/dev/null; then
            echo "‚úÖ –í–µ—Ç–∫–∞ $BRANCH_NAME –æ—Ç–≤–µ—Ç–≤–ª–µ–Ω–∞ –æ—Ç main"
          else
            echo "$ERROR_MSG"
            echo "‚ùå –í–µ—Ç–∫–∞ $BRANCH_NAME –Ω–µ –æ—Ç–≤–µ—Ç–≤–ª–µ–Ω–∞ –æ—Ç develop –∏–ª–∏ main"
            exit 1
          fi

          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã –¥–ª—è –≤–µ—Ç–∫–∏ $BRANCH_NAME"
